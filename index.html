<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>8番出口ライク：春はあけぼの判別ゲーム</title>
<style>
  :root{
    --bg:#0f1216; --panel:#171b21; --text:#e8edf3; --muted:#9aa4b2; --accent:#39c3ff; --good:#5cd67a; --bad:#ff6473; --warn:#facc15;
  }
  html,body{height:100%;}
  body{margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", "Yu Gothic", sans-serif; background:linear-gradient(180deg,#0e1115,#141922 50%,#0e1115); color:var(--text); display:grid; place-items:center;}
  .wrap{width:min(1100px,94vw);}
  header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin:18px 0 8px;}
  h1{font-size:clamp(16px,2.6vw,22px); font-weight:700; letter-spacing:.04em; margin:0; color:#d9e3f0}
  .info{display:flex; gap:10px; align-items:center; color:var(--muted); font-size:14px}
  .badge{background:#1d2330; border:1px solid #2a3344; padding:6px 10px; border-radius:999px;}

  .board{background:var(--panel); border:1px solid #2a3344; box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03); border-radius:18px; padding:24px;}
  .stageRow{display:flex; align-items:center; justify-content:space-between; gap:16px;}
  .exit{font-size:clamp(22px,4.5vw,36px); font-weight:800; letter-spacing:.08em; color:#cfe6ff}
  .exit small{display:block; font-weight:600; font-size:12px; color:var(--muted); letter-spacing:.12em}

  .textBox{margin:20px 0; background:#0f131b; border:1px solid #243046; border-radius:16px; padding:26px; min-height:150px; display:flex; align-items:center; justify-content:center; text-align:center; transition:opacity 0.3s ease;}
  .waka{font-size:clamp(18px,3.2vw,26px); line-height:1.9; letter-spacing:.04em; text-wrap:balance;}

  .buttons{display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:10px}
  button{appearance:none; border:none; cursor:pointer; padding:18px 16px; border-radius:14px; font-size:clamp(16px,2.6vw,18px); font-weight:750; transition:transform .05s ease, box-shadow .15s ease, filter .15s ease;}
  button:active{transform:translateY(1px)}
  .btn-back{background:#1c2433; color:#d9e6ff; border:1px solid #2a3344}
  .btn-next{background:linear-gradient(180deg,#1e7bb8,#1592d6); color:white; box-shadow:0 8px 20px rgba(57,195,255,.25)}

  .status{margin-top:14px; color:var(--muted); font-size:14px}
  .status strong{color:#e7f5ff}

  .toast{position:fixed; inset:auto 16px 16px auto; background:#10161f; border:1px solid #2a3344; border-left:4px solid var(--accent); border-radius:12px; padding:12px 14px; color:var(--text); box-shadow:0 10px 30px rgba(0,0,0,.35); opacity:0; transform:translateY(6px); pointer-events:none}
  .toast.show{opacity:1; transform:translateY(0); transition:opacity .15s ease, transform .15s ease}
  .toast.good{border-left-color:var(--good)}
  .toast.bad{border-left-color:var(--bad)}

  .win{display:none; text-align:center; padding:30px}
  .win h2{font-size:clamp(24px,5vw,40px); margin:0 0 10px}
  .win p{color:var(--muted)}

  .footer{margin-top:18px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; color:var(--muted); font-size:12px}
  .controls{display:flex; gap:8px; flex-wrap:wrap}
  .ghost{opacity:.7;}
  .tiny{font-size:12px; color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>8番出口ライク：春はあけぼの判別ゲーム</h1>
      <div class="info">
        <span class="badge">0 → 8 を目指せ</span>
        <span class="badge" id="progressBadge">正解連続: 0</span>
      </div>
    </header>

    <div class="board" id="board">
      <div class="stageRow">
        <div class="exit">出口 <span id="exitNum">0</span><small>現在地</small></div>
        <div class="tiny">提示文が <strong>完全一致</strong> なら「進む」／一文字でも違うなら「引き返す」</div>
      </div>

      <div class="textBox"><div id="waka" class="waka">—</div></div>

      <div class="buttons">
        <button class="btn-back" id="btnBack">引き返す</button>
        <button class="btn-next" id="btnNext">進む</button>
      </div>

      <div class="status" id="status">判定中…</div>

      <div class="win" id="win">
        <h2>脱出成功！🎉</h2>
        <p>8番出口で正解しました。もう一度遊ぶには「リスタート」を押してください。</p>
      </div>

      <div class="footer">
        <div class="controls">
          <button id="restart" class="btn-back" style="padding:10px 12px; font-weight:700">リスタート</button>
          <label class="ghost"><input type="checkbox" id="hardMode"> 難しめ（微細な揺さぶりを増やす）</label>
        </div>
        <div class="tiny">© 枕草子 第一段／本文の完全一致のみ正とする（空白・句読点・仮名遣いを含む）</div>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

<script>
(() => {
  const ORIGINAL = "春はあけぼの。やうやう白くなりゆく山ぎは、少し明かりて、紫だちたる雲の細くたなびきたる。";
  const subtleEdits = [
    s => s.replace("やうやう","ようよう"),
    s => s.replace("山ぎは","山際"),
    s => s.replace("少し","すこし"),
    s => s.replace("明かりて","あかりて"),
    s => s.replace("紫だちたる","紫立ちたる"),
    s => s.replace("細く","ほそく"),
    s => s.replace("たなびきたる","たなびける"),
    s => s.replace("。","、"),
    s => s.replace("、","，"),
    s => s.replace("山ぎは","山ぎは\u00A0"),
    s => s.replace("雲の","雲 の"),
    s => s.replace("あけぼの","あけもの"),
    s => s.replace("白く","白 く"),
  ];

  function jitterTypography(el){
    el.style.letterSpacing = (Math.random() < 0.5 ? "0.02em" : "0.04em");
    el.style.wordSpacing   = (Math.random() < 0.5 ? "0em" : "0.08em");
  }

  let exit = 0;
  let streak = 0;
  let currentIsExact = true;

  const wakaEl = document.getElementById('waka');
  const textBox = document.querySelector('.textBox');
  const exitNumEl = document.getElementById('exitNum');
  const statusEl = document.getElementById('status');
  const toastEl = document.getElementById('toast');
  const winEl = document.getElementById('win');
  const progressBadge = document.getElementById('progressBadge');
  const hardModeChk = document.getElementById('hardMode');

  function showToast(msg, good=false){
    toastEl.textContent = msg;
    toastEl.className = 'toast show ' + (good ? 'good' : 'bad');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toastEl.classList.remove('show'), 1300);
  }

  function sampleEdits(){
    const hard = hardModeChk.checked;
    const count = hard ? randInt(1,3) : randInt(0,2);
    const picks = shuffle([...subtleEdits]).slice(0,count);
    let s = ORIGINAL;
    for(const f of picks){ s = f(s); }
    return s;
  }

  function newRound(){
    textBox.style.opacity = 0; // 一旦非表示
    setTimeout(() => {
      winEl.style.display = 'none';
      exitNumEl.textContent = String(exit);
      const changeProb = hardModeChk.checked ? 0.65 : 0.45;
      const willChange = Math.random() < changeProb;
      const shown = willChange ? sampleEdits() : ORIGINAL;
      currentIsExact = (shown === ORIGINAL);
      wakaEl.textContent = shown;
      jitterTypography(wakaEl);
      statusEl.innerHTML = `出口 <strong>${exit}</strong>：提示文が <strong>${currentIsExact? '完全一致' : '相違あり'}</strong> かを見抜いてください。`;
      textBox.style.opacity = 1; // 1秒後再表示
    }, 1000);
  }

  function handleAnswer(goForward){
    const correct = (currentIsExact && goForward) || (!currentIsExact && !goForward);
    if(correct){
      streak++;
      progressBadge.textContent = `正解連続: ${streak}`;
      showToast(exit === 8 ? '正解！脱出！' : '正解！次の出口へ →', true);
      if(exit === 8){
        winEl.style.display = 'block';
        statusEl.innerHTML = `<strong>脱出成功！</strong> リスタートで再挑戦できます。`;
        exit = 0;
      } else {
        exit++;
      }
      newRound();
    } else {
      streak = 0;
      progressBadge.textContent = `正解連続: ${streak}`;
      showToast('不正解… 0番出口に戻ります', false);
      exit = 0;
      newRound();
    }
  }

  function restart(){
    exit = 0; streak = 0; progressBadge.textContent = `正解連続: ${streak}`; newRound();
  }

  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }

  document.getElementById('btnNext').addEventListener('click', () => handleAnswer(true));
  document.getElementById('btnBack').addEventListener('click', () => handleAnswer(false));
  document.getElementById('restart').addEventListener('click', restart);
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'ArrowRight') handleAnswer(true);
    if(e.key === 'ArrowLeft') handleAnswer(false);
    if(e.key.toLowerCase() === 'r') restart();
  });

  newRound();
})();
</script>
</body>
</html>